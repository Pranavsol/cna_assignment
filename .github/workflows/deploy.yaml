name: üîê DevSecOps Offline Pipeline

on:
  push:
    branches:
      - main

env:
  TF_VERSION: "1.9.8"
  KUBE_CONFIG_PATH: "/tmp/kubeconfig"

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 1Ô∏è‚É£ Checkout ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 2Ô∏è‚É£ Docker Setup ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 3Ô∏è‚É£ Build Services ---
      - name: Build Service A
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/service-a:latest ./service-a

      - name: Build Service B
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/service-b:latest ./service-b

      # --- 4Ô∏è‚É£ DevSecOps Scans ---
      - name: üß© Scan Service A with Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ secrets.DOCKERHUB_USERNAME }}/service-a:latest
          sarif-file: results-service-a.sarif
          summary: true
          format: json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          write-comment: true

      - name: üß© Scan Service B with Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ secrets.DOCKERHUB_USERNAME }}/service-b:latest
          sarif-file: results-service-b.sarif
          summary: true
          format: json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          write-comment: true

      # --- 5Ô∏è‚É£ Push Docker Images ---
      - name: Push Docker Images
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/service-a:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/service-b:latest

      # --- 6Ô∏è‚É£ Setup Terraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # --- 7Ô∏è‚É£ Setup kubectl ---
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      # --- 8Ô∏è‚É£ Configure Kubeconfig ---
      - name: Write kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > $KUBE_CONFIG_PATH
          chmod 600 $KUBE_CONFIG_PATH
          mkdir -p ~/.kube
          cp $KUBE_CONFIG_PATH ~/.kube/config
        shell: bash

      # --- 9Ô∏è‚É£ Terraform Stage: Deploy Apps ---
      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform
        env:
          KUBECONFIG: ${{ env.KUBE_CONFIG_PATH }}
          TF_VAR_dockerhub_user: ${{ secrets.DOCKERHUB_USERNAME }}
          TF_VAR_db_user: ${{ secrets.POSTGRES_USER }}
          TF_VAR_db_pass: ${{ secrets.POSTGRES_PASSWORD }}
          TF_VAR_db_name: "cna_assignment"

      # --- üîü Optional: Save Terraform State ---
      - name: Save Terraform state artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/terraform.tfstate
